<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maze Battleground: Pixel Perfect</title>
    <link rel="icon" type="image/x-icon" href="images/maze.ico">
    <script src="libs/nipplejs.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>

<!-- <body tabindex="0" onclick="focus()"> -->

<body tabindex="0">
    <div class="arcade-header">
        <div class="header-bar">
            <div class="game-title">MAZE BATTLEGROUNDS<span
                    style="font-size:0.5em; opacity:0.5; vertical-align: middle;">MAYHEM</span></div>
            <div class="round-info" id="statusText">SELECT MODE</div>
        </div>

        <div class="dashboard">
            <div class="panel" id="p1-panel">
                <div class="panel-header" id="p1-header">PLAYER 1</div>
                <div class="control-group">
                    <div class="c-row">
                        <span class="action-name act-mov">MOVE</span>
                        <div><span class="key-cap">W</span><span class="key-cap">A</span><span
                                class="key-cap">S</span><span class="key-cap">D</span></div>
                    </div>
                    <div class="c-row">
                        <span class="action-name act-atk">MINE/BOOM</span>
                        <div><span class="key-cap">E</span>+<span class="key-cap">SPC</span></div>
                    </div>
                    <div class="c-row">
                        <span class="action-name act-def">SHIELD</span><span class="key-cap">R</span>
                    </div>
                    <div class="c-row">
                        <span class="action-name act-def">BEAM</span><span class="key-cap">F</span>
                    </div>
                    <div class="c-row">
                        <span class="action-name act-mov">BOOST</span><span class="key-cap">G</span>
                    </div>
                </div>
            </div>

            <div class="panel rules-panel">
                <div class="panel-header" style="color: #aaa; font-size: 0.75em; letter-spacing: 4px;">SYSTEM MECHANICS
                    <button class="info-btn" onclick="toggleDesktopRules()">?</button>
                </div>
                <div class="legend-grid">
                    <div class="legend-item">
                        <span class="l-icon">â˜ </span>
                        <div class="l-text"><span class="l-title hl-red">MINES</span><span class="l-desc">Lethal. 1
                                Pt.</span></div>
                    </div>
                    <div class="legend-item">
                        <span class="l-icon">ðŸ›¡</span>
                        <div class="l-text"><span class="l-title hl-blue">SHIELD</span><span class="l-desc">Blocks
                                All.</span></div>
                    </div>
                    <div class="legend-item">
                        <span class="l-icon">âš¡</span>
                        <div class="l-text"><span class="l-title hl-gold">TAP BEAM</span><span class="l-desc">Stuns
                                Enemy.</span></div>
                    </div>
                    <div class="legend-item">
                        <span class="l-icon">ðŸ’¥</span>
                        <div class="l-text"><span class="l-title hl-gold">HOLD BEAM</span><span class="l-desc">Break
                                Wall/Kill.</span></div>
                    </div>
                    <div class="legend-item">
                        <span class="l-icon">ðŸŒ€</span>
                        <div class="l-text"><span class="l-title hl-purple">PORTAL</span><span
                                class="l-desc">Teleport.</span></div>
                    </div>
                    <div class="legend-item">
                        <span class="l-icon">âš </span>
                        <div class="l-text"><span class="l-title hl-red">GLITCH</span><span class="l-desc">Invert
                                Ctrl.</span></div>
                    </div>
                </div>
            </div>

            <div class="panel" id="p2-panel">
                <div class="panel-header" id="p2-header">PLAYER 2 / CPU</div>
                <div class="control-group">
                    <div class="c-row">
                        <div><span class="key-cap">^</span><span class="key-cap">&lt;</span><span
                                class="key-cap">v</span><span class="key-cap">&gt;</span></div><span
                            class="action-name act-mov">MOVE</span>
                    </div>
                    <div class="c-row">
                        <div><span class="key-cap">O</span>+<span class="key-cap">ENT</span></div><span
                            class="action-name act-atk">MINE/BOOM</span>
                    </div>
                    <div class="c-row">
                        <span class="key-cap">I</span><span class="action-name act-def">SHIELD</span>
                    </div>
                    <div class="c-row">
                        <span class="key-cap">K</span><span class="action-name act-def">BEAM</span>
                    </div>
                    <div class="c-row">
                        <span class="key-cap">L</span><span class="action-name act-mov">BOOST</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="console-case">
        <div class="screen-bezel">
            <canvas id="ledMatrix" width="1280" height="640"></canvas>
        </div>
        <div class="panel-id">P2.5 RGB LED panel 128px x 64px - 320mm x 160mm</div>
    </div>
    <div class="info">MENU: W/S + SPACE | GAME: 'R' NEXT ROUND/RESET | 'ESC' MENU |
        <span style="color: #ffaa00;">âš  ANTI-GHOSTING KEYBOARD RECOMENDED</span>
    </div>

    <div id="desktop-rules-modal" onclick="if(event.target===this)toggleDesktopRules()">
        <div class="desktop-modal-content">
            <div class="dm-header">
                <h3>SYSTEM MECHANICS</h3>
                <button class="dm-close" onclick="toggleDesktopRules()">X</button>
            </div>

            <div class="dm-columns">
                <div class="dm-section">
                    <h4 class="hl-gold">OBJECTIVE</h4>
                    <p>First to <strong>5 points</strong> wins. Score by reaching the opponent's spawn zone (Goal) or
                        eliminating them with mines, explosions, or a charged beam.</p>
                </div>

                <div class="dm-section">
                    <h4 class="hl-gold">ENERGY SYSTEM</h4>
                    <p>All actions share a single <strong>Energy bar (0-150)</strong> that slowly regenerates.
                        Mismanaging energy leaves you vulnerable.</p>
                    <table class="dm-table">
                        <tr>
                            <td class="hl-gold">Tap Beam</td>
                            <td>30 energy</td>
                            <td>Quick stun attack</td>
                        </tr>
                        <tr>
                            <td class="hl-gold">Charged Beam</td>
                            <td>65 energy</td>
                            <td>Hold ~3s, lethal + breaks walls (no regen while charging)</td>
                        </tr>
                        <tr>
                            <td class="hl-blue">Shield</td>
                            <td>10 + drain</td>
                            <td>Blocks all damage (~6s to empty)</td>
                        </tr>
                        <tr>
                            <td class="hl-green">Boost</td>
                            <td>drain</td>
                            <td>Sprint speed (~6s to empty)</td>
                        </tr>
                        <tr>
                            <td class="hl-red">Detonate</td>
                            <td>30 energy</td>
                            <td>Remote-trigger your mines</td>
                        </tr>
                    </table>
                </div>

                <div class="dm-section">
                    <h4 class="hl-red">MINES</h4>
                    <p>Place up to <strong>4 mines</strong> (refill via green ammo crates). Mines arm after ~1 second.
                        Stepping on or detonating a mine creates a large explosion that destroys nearby walls and kills
                        players in range. Friendly fire applies.</p>
                </div>

                <div class="dm-section">
                    <h4 class="hl-purple">PORTALS</h4>
                    <p>Two portals link points on the map. Entering one teleports you to the other with brief
                        invulnerability. Each use has a <strong>30% chance</strong> of glitching your controls (inverted
                        movement for ~3 seconds).</p>
                </div>

                <div class="dm-section">
                    <h4 class="hl-red">SUDDEN DEATH</h4>
                    <p>When time runs low (&lt;30s), neutral mines spawn randomly (max 12, spaced apart) every ~830ms,
                        increasing chaos until one player is eliminated.</p>
                </div>

                <div class="dm-section">
                    <h4 class="hl-blue">SCORING</h4>
                    <ul>
                        <li><strong>Goal:</strong> Reach the opponent's spawn zone (+1 pt)</li>
                        <li><strong>Elimination:</strong> Kill the opponent via mine, explosion, or charged beam (+1 pt)
                        </li>
                        <li><strong>Double KO:</strong> Both players die simultaneously (draw, no points)</li>
                        <li><strong>Timeout:</strong> Player with higher score wins; draw if tied</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Lobby Modal -->
    <div id="lobby-modal" class="lobby-modal">
        <div class="lobby-content">
            <div class="lobby-header">
                <h3>ONLINE MULTIPLAYER</h3>
                <button id="close-lobby-btn" class="lobby-close-btn">X</button>
            </div>

            <div id="lobby-error" class="lobby-error"></div>

            <!-- Connection Section -->
            <div id="connect-section" class="lobby-section">
                <label for="server-url">Server URL:</label>
                <div class="input-row">
                    <input type="text" id="server-url"
                        placeholder="wss://maze-battlegrounds-tabletop-arcade.onrender.com">
                    <button id="connect-btn" class="lobby-btn">Connect</button>
                </div>
            </div>

            <!-- Lobby View (shown after connecting) -->
            <div id="lobby-view" class="lobby-section" style="display: none;">
                <div class="create-room-row">
                    <input type="text" id="room-name-input" placeholder="Room name (optional)">
                    <button id="create-room-btn" class="lobby-btn accent">Create Room</button>
                    <button id="refresh-rooms-btn" class="lobby-btn small">â†»</button>
                </div>

                <div class="room-list-header">Available Rooms:</div>
                <div id="room-list" class="room-list">
                    <div class="room-item empty">No rooms available</div>
                </div>
            </div>

            <!-- Room View (shown when in a room) -->
            <div id="room-view" class="lobby-section" style="display: none;">
                <div class="room-info">
                    <span class="room-label">Room:</span>
                    <span id="room-name-display" class="room-name-text">---</span>
                </div>

                <div class="players-section">
                    <div class="players-header">Players:</div>
                    <div id="player-list" class="player-list">
                        <div class="player-slot"><span class="player-icon empty">&#9675;</span> Waiting...</div>
                        <div class="player-slot"><span class="player-icon empty">&#9675;</span> Waiting...</div>
                    </div>
                </div>

                <div class="room-actions">
                    <button id="leave-room-btn" class="lobby-btn danger">Leave Room</button>
                    <button id="start-game-btn" class="lobby-btn accent" style="display: none;" disabled>Start
                        Game</button>
                </div>
            </div>

            <!-- Connection Status -->
            <div id="connection-status" class="connection-status">
                <span class="status-dot disconnected"></span>
                <span class="status-text">Not connected</span>
            </div>
        </div>
    </div>

    <!-- Disconnect Overlay (shown during gameplay if connection is lost) -->
    <div id="disconnect-overlay" class="disconnect-overlay" style="display: none;">
        <div class="disconnect-content">
            <div class="disconnect-icon">âš </div>
            <div class="disconnect-title">CONNECTION LOST</div>
            <div class="disconnect-message">Attempting to reconnect...</div>
        </div>
    </div>

    <div id="mobile-rules-modal">
        <div class="modal-content">
            <h3 style="border-bottom: 1px solid #333; padding-bottom: 5px;">SYSTEM MECHANICS</h3>

            <div class="m-rule"><span class="icon">â˜ </span> <span style="color:#ff5555">MINES</span>: Lethal (1 Pt)
            </div>
            <div class="m-rule"><span class="icon">ðŸ›¡</span> <span style="color:#55ffff">SHIELD</span>: Blocks All</div>
            <div class="m-rule"><span class="icon">âš¡</span> <span style="color:#ffd700">TAP BEAM</span>: Stuns Enemy
            </div>
            <div class="m-rule"><span class="icon">ðŸ’¥</span> <span style="color:#ffd700">HOLD BEAM</span>: Break/Kill
            </div>
            <div class="m-rule"><span class="icon">ðŸŒ€</span> <span style="color:#ff55ff">PORTAL</span>: Teleport</div>
            <div class="m-rule"><span class="icon">âš </span> <span style="color:#ff5555">GLITCH</span>: Invert Controls
            </div>

            <div class="close-btn" onclick="toggleRules()">CLOSE</div>
        </div>
    </div>
    <div id="mobile-config">
        <div class="touch-area config">
            <!-- <div class="btnInfo" style="border-color: #00b7ff; color: #00b7ff;" onclick="toggleRules()">?</div> -->
            <div class="btn" style="border-color: #00e1ff; color: #ffd700;" data-key="KeySelect">ESC</div>
            <div class="btn" style="border-color: #00ff00; color: #00ff00;" data-key="KeyStart">Start</div>
        </div>
    </div>
    <div id="mobile-controls">
        <div id="joystick-zone"></div>
        <div id="cross-zone" class="touch-area cross">
            <div class="btn" style="border-color: #55ffff; color: #55ffff;" data-key="KeyW">up</div>
            <div class="btn" style="border-color: #00ff00; color: #00ff00;" data-key="KeyS">down</div>
            <div class="btn" style="border-color: #ffd700; color: #ffd700;" data-key="KeyA">left</div>
            <div class="btn" style="border-color: #ff5555; color: #ff5555;" data-key="KeyD">right</div>
        </div>
        <div class="touch-area actions">
            <div class="btn" style="border-color: #55ffff; color: #55ffff;" data-key="KeyR">SHLD</div>
            <div class="btn" style="border-color: #00ff00; color: #00ff00;" data-key="KeyG">BOOST</div>
            <div class="btn" style="border-color: #ffd700; color: #ffd700;" data-key="KeyF">BEAM</div>
            <div class="btn" style="border-color: #ff5555; color: #ff5555;" data-key="Space">BOOM</div>
            <div class="btn" style="border-color: #ff55ff; color: #ff55ff;" data-key="KeyE">MINE</div>
        </div>
    </div>
    <script type="module" src="js/menu-maze.js"></script>
    <script type="module" src="js/main.js"></script>
    <script>
        function toggleDesktopRules() {
            const modal = document.getElementById('desktop-rules-modal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
            }
        }
        function toggleRules() {
            const modal = document.getElementById('mobile-rules-modal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
            }
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Auto-detect server URL based on page hostname
            const serverUrlInput = document.getElementById('server-url');
            if (serverUrlInput) {
                const hostname = window.location.hostname;
                const isSecure = window.location.protocol === 'https:';
                const wsProtocol = isSecure ? 'wss://' : 'ws://';

                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    // Local development
                    serverUrlInput.value = 'ws://localhost:8080';
                } else if (hostname.includes('github.io') || hostname.includes('obrelix')) {
                    // GitHub Pages - use public Render server
                    serverUrlInput.value = 'wss://maze-battlegrounds-tabletop-arcade.onrender.com';
                } else if (hostname && !hostname.includes('file')) {
                    // Self-hosted - use same host with appropriate protocol
                    serverUrlInput.value = `${wsProtocol}${hostname}:8080`;
                }
            }

            // Select all game buttons
            const gameButtons = document.querySelectorAll('.btn, .btnInfo');

            gameButtons.forEach(btn => {
                // Function to Turn ON the glow
                const activate = (e) => {
                    // Prevent browser zooming/scrolling on the button
                    if (e.cancelable) e.preventDefault();

                    btn.classList.add('manual-active');

                    // OPTIONAL: Trigger your game key press here if it wasn't working
                    // triggerKey(btn.getAttribute('data-key')); 
                };

                // Function to Turn OFF the glow
                const deactivate = (e) => {
                    btn.classList.remove('manual-active');
                };

                // Touch Events (Mobile)
                btn.addEventListener('touchstart', activate, { passive: false });
                btn.addEventListener('touchend', deactivate);
                btn.addEventListener('touchcancel', deactivate);

                // Mouse Events (PC testing)
                btn.addEventListener('mousedown', activate);
                btn.addEventListener('mouseup', deactivate);
                btn.addEventListener('mouseleave', deactivate);
            });
        });
    </script>
</body>

</html>